global TLGV;
load_CCT_LUTs;
TLGV.setting.com='com3';         %please set the RIGHT com port number connected to LED device, you can find it in your PC->device manager
TLGV.setting.modeN=1;            %0~79, correspond to the 80 modes saved in your LED device hardware. Please set it to 1.
%id;                 %The id of LED device
TLGV.setting.timeout=1;          %Set the maxium waiting time to receive LED device's response
                    %Set timeout=0 if you want to ignore the feedback from LED device to get fast respond.
%If the connection is robust, you can set it 0 to save
%time. However, if the connection is weak, we suggest you set timeout
%to 2 seconds or more to check if each LED device work well.
TLGV.droot = 'D:\颜色实验用程序\Tunable light source';
TLGV.obs = 10;
TLGV.bit = 10;
% TLGV.receipe_list=[15	422	150	15	21	15	15	15	15	467	15	15	873	977
%               15	438	156	15	85	15	15	15	15	189	15	15	310	764
%               15	126	199	15	81	15	15	15	15	165	15	15	303	687
%               15	15	251	15	58	15	15	15	17	102	15	15	304	674
%               15	394	176	15	103	15	15	40	25	211	15	15	272	854
%               15	621	44	15	126	15	15	15	15	209	290	15	124	826
%               15	15	199	15	42	16	15	15	15	55	15	15	193	379
%               15	15	208	24	42	15	15	15	15	59	15	15	190	378
%               17	798	120	40	79	18	18	23	15	162	18	15	139	707
%               15	354	159	40	139	15	15	40	26	130	15	15	53	805
%               15	410	15	15	153	15	15	15	15	143	420	15	15	784
%               15	631	25	33	153	24	15	15	15	146	351	15	15	804
%               15	15	177	34	34	41	15	15	15	31	15	15	134	259
%               15	15	185	47	31	23	15	15	15	35	15	15	135	258
%               15	15	190	54	29	15	15	21	24	41	15	16	136	257
%               15	15	201	61	28	15	15	41	31	47	15	17	134	255
%               15	149	15	15	110	36	15	15	15	102	453	15	15	785
%               15	15	97	16	46	59	15	15	15	34	204	16	114	214
%               15	172	76	15	88	55	15	15	15	72	234	15	72	58
%               21	15	155	50	24	47	24	15	15	19	15	24	109	201
%               15	15	166	60	24	38	15	15	20	21	15	25	106	199
%               15	15	176	70	22	24	15	28	27	24	15	25	104	198
%               15	15	182	82	26	18	15	43	34	35	15	23	95	196
%               15	15	15	15	96	15	15	15	15	15	517	15	15	692
%               15	32	66	15	61	89	15	15	15	61	267	15	66	57
%               15	49	115	33	66	58	65	15	15	36	80	15	61	57
%               43	15	133	71	21	56	28	15	15	22	15	23	110	158
%               35	15	144	81	18	48	15	19	19	24	15	24	108	156
%               15	15	163	89	16	35	15	38	27	23	15	24	104	154
%               15	15	174	98	15	19	15	56	35	28	15	25	103	152
%               15	44	76	35	52	88	111	15	15	20	142	37	52	55
%               66	48	67	52	46	69	87	15	15	35	98	27	53	56
%               79	50	71	61	49	57	70	24	15	40	81	37	56	56
%               51	41	101	103	31	55	32	21	23	15	73	37	60	56
%               49	45	118	111	24	49	20	32	26	15	37	49	61	57
%               38	15	141	113	15	44	15	50	33	15	15	40	70	115
%               15	15	163	118	15	32	15	70	41	15	15	39	66	111
%               94	44	36	90	36	88	110	16	15	20	101	58	46	55
%               112	15	25	122	22	115	15	15	17	28	178	61	72	102
%               112	15	48	125	15	99	16	22	22	21	106	62	68	98
%               146	32	62	136	15	74	20	22	25	19	15	63	62	95
%               101	15	94	135	15	71	15	43	32	15	15	63	54	90
%               65	15	120	139	15	54	15	62	41	15	15	63	48	85
%               30	23	146	143	15	40	15	83	49	15	15	63	42	84
%               98	38	27	135	31	98	108	23	21	15	103	84	44	55
%               90	41	40	140	26	87	89	33	25	15	96	85	46	55
%               149	15	33	149	17	114	15	29	28	18	74	81	57	85
%               148	15	57	153	15	97	15	36	32	15	15	82	50	81
%               111	15	83	154	15	79	15	54	40	15	15	82	46	77
%               78	15	109	156	15	62	15	73	48	15	15	82	38	74
%               45	48	133	159	15	46	15	93	55	15	15	83	34	71
%               95	33	21	159	25	108	115	38	32	15	104	96	41	54
%               94	42	31	153	26	94	99	53	30	15	97	110	44	55
%               90	43	44	163	15	84	76	58	40	21	83	99	47	55
%               160	15	46	171	15	106	15	48	39	15	15	101	45	73
%               124	15	72	172	15	86	15	66	47	15	15	101	39	69
%               84	20	100	173	15	66	15	85	55	15	15	100	32	65
%               46	68	126	174	15	51	15	104	63	15	15	101	25	62];
TLGV.receipe_list=[23	799	23	15	91	15	15	25	20	66	32	25	126	279];
TLGV.receipe_list=[23	799	23	15	91	15	15	25	20	66	32	25	126	279
13	556	121	20	82	12	12	48	30	185	13	17	62	40
14	192	425	23	104	13	14	102	94	517	14	42	192	105
14	467	1023	18	370	14	14	245	146	1023	14	73	316	153
10	169	63	8	34	6	7	11	14	100	12	14	30	14
13	579	127	22	60	11	11	25	24	142	13	15	51	29
13	656	424	39	114	11	11	56	63	336	13	24	99	38
14	697	1023	32	381	14	14	122	115	603	14	50	199	114
8	124	69	6	29	5	6	3	9	75	12	12	26	14
12	146	145	11	61	12	13	9	11	147	14	13	59	22
14	346	453	14	138	13	13	18	36	210	13	15	86	54
66	788	1023	15	219	14	14	17	82	406	14	34	229	73
12	683	13	11	14	14	23	5	9	138	83	12	14	227
14	1000	25	14	14	14	20	16	18	260	289	16	285	350
14	1023	383	13	14	20	158	10	12	286	14	13	666	1009
22	980	719	99	998	37	14	15	14	947	710	20	65	777
11	473	13	10	14	14	14	1	7	136	130	11	18	800
12	792	12	11	14	14	14	4	8	371	345	12	14	213
14	1023	107	14	15	14	14	14	14	1023	925	14	305	1023
13	1023	338	13	1023	14	64	10	12	1023	1023	13	14	811
16	635	16	22	22	28	15	18	48	96	69	31	86	820
14	597	122	52	32	12	12	56	30	107	13	15	37	14
14	127	427	140	120	13	13	121	75	283	14	32	114	75
14	471	1023	400	225	14	14	208	136	544	14	66	243	160
15	357	36	15	78	14	14	18	16	51	52	37	29	236
12	77	158	36	24	4	5	28	26	57	11	18	26	15
13	438	436	144	58	12	12	65	60	127	13	22	56	31
57	399	1023	307	130	13	13	108	111	281	14	47	130	53
15	541	15	15	43	14	14	16	15	26	99	15	237	19
14	109	128	31	45	13	13	20	16	89	66	15	39	30
33	61	464	105	28	8	8	22	36	37	12	16	32	24
86	191	1023	278	57	12	12	17	68	106	13	30	69	44
14	354	15	14	14	14	14	13	13	91	133	14	14	892
23	31	153	16	14	15	16	1	7	20	15	11	15	14
14	70	433	55	26	50	15	13	13	43	96	14	37	38
14	459	954	188	42	33	14	15	24	59	355	14	51	49
12	345	13	12	14	14	14	6	10	79	147	12	14	783
15	1023	24	15	395	60	14	17	16	14	300	15	14	747
15	696	238	16	167	135	51	21	18	305	460	27	14	969
14	773	717	15	195	519	14	16	15	587	637	15	15	863
11	299	12	10	14	14	14	0	6	72	160	11	14	785
12	1023	12	11	14	14	114	3	8	267	246	11	14	14
15	1023	17	23	112	18	131	18	16	1023	1023	15	15	14
13	242	295	13	494	14	360	10	12	1023	1023	13	14	803
15	605	16	15	14	14	14	69	15	14	110	14	98	867
30	58	137	71	23	9	9	68	36	48	12	16	24	14
72	107	396	233	42	12	12	151	84	69	13	32	38	22
130	667	904	791	105	14	14	237	130	147	14	63	88	41
82	410	15	39	14	12	12	23	19	15	13	16	104	963
41	165	122	108	20	10	10	38	28	39	13	16	21	19
116	130	356	348	45	13	13	68	57	75	14	26	36	24
275	358	809	735	43	31	14	119	105	81	14	51	64	35
31	26	56	30	14	12	12	14	14	20	13	14	14	14
75	62	103	90	29	11	11	21	20	34	32	16	27	14
131	14	354	354	19	30	12	19	44	24	13	21	26	21
340	369	741	677	33	128	14	35	78	36	14	39	39	16
33	17	52	25	14	20	15	8	11	18	14	13	14	14
56	14	117	62	14	46	14	15	14	14	16	14	14	14
89	247	309	306	14	111	22	17	26	57	109	15	44	34
290	160	666	568	19	200	14	14	45	32	268	29	30	29
13	106	29	18	21	22	14	10	12	35	108	13	21	14
45	44	94	41	14	53	14	11	12	14	103	13	14	14
68	34	251	207	66	81	35	16	30	26	375	15	23	14
155	14	617	436	23	328	14	15	33	14	627	18	69	29
13	511	14	13	14	14	97	9	11	14	43	13	210	14
14	14	74	29	14	52	14	10	12	25	229	13	15	15
76	14	204	110	14	129	14	14	14	14	539	14	18	17
162	14	470	246	15	375	14	14	14	14	1023	14	25	24
13	459	14	12	14	15	113	8	11	47	51	12	14	1023
15	1023	15	15	14	14	255	19	16	147	144	15	14	824
14	692	246	14	14	77	646	15	15	206	50	14	79	124
85	544	550	15	72	448	970	18	16	363	292	15	15	517
16	14	63	15	14	15	15	57	14	14	14	39	14	130
50	76	111	117	36	15	13	82	35	70	14	16	30	14
120	123	342	360	32	23	13	173	85	68	14	36	38	30
298	250	750	1023	76	14	14	270	146	148	14	74	67	41
65	236	24	46	23	11	11	31	19	35	13	16	19	22
59	30	114	134	15	12	11	52	31	29	13	15	18	14
150	35	321	414	27	44	13	107	68	42	14	32	31	22
249	252	756	1023	34	143	24	184	114	75	14	58	45	15
61	24	30	55	14	13	13	18	16	57	19	15	18	28
76	16	103	158	14	16	11	27	24	21	13	16	15	14
193	14	289	443	18	74	13	53	51	23	14	25	24	19
409	14	649	925	27	257	14	95	93	29	14	50	39	31
48	15	40	44	14	23	14	14	14	15	14	14	14	14
95	14	88	131	14	38	13	18	16	14	14	15	14	14
217	50	257	439	21	129	19	15	37	14	22	20	19	15
480	262	552	843	15	468	25	30	65	14	14	38	31	27
48	14	37	34	14	39	15	10	12	14	14	13	14	14
83	36	66	105	14	52	14	17	15	20	97	15	14	14
218	14	195	353	14	159	14	15	27	14	203	15	16	15
363	17	464	768	14	502	28	19	50	15	448	29	17	18
45	14	30	27	14	48	15	7	10	14	41	12	14	14
51	34	56	89	14	68	14	16	15	16	179	14	14	14
186	341	130	286	14	207	32	22	21	14	383	14	14	14
341	14	325	645	14	560	14	14	34	14	920	22	23	22
14	14	41	14	14	40	85	12	13	14	14	14	14	718
16	1013	46	93	14	14	301	23	19	14	14	16	274	821
205	470	128	180	17	251	357	18	29	177	97	15	84	819
101	37	588	86	305	1023	900	147	34	42	77	14	46	843
15	499	16	53	14	14	14	87	15	14	101	14	31	840
25	1023	15	164	114	14	14	15	34	14	308	639	15	868
288	1023	183	409	62	14	14	226	128	14	114	76	144	184
14	1023	587	1023	14	19	14	14	781	14	1023	975	14	1023
29	536	18	49	17	14	59	37	26	20	14	99	15	227
80	38	93	166	18	19	12	70	36	33	13	16	20	14
195	32	272	514	27	70	13	147	79	41	14	37	31	20
407	42	582	1023	81	335	14	304	157	164	14	80	86	43
80	86	18	71	17	12	11	27	18	38	13	16	17	15
94	17	84	187	14	27	12	48	29	23	13	15	15	14
264	55	212	563	41	123	14	89	61	67	14	33	33	19
459	331	522	1023	14	498	14	210	123	52	14	65	37	20
58	14	31	79	14	22	12	19	17	19	13	15	14	14
119	14	68	202	14	35	13	26	23	17	13	15	14	14
279	31	189	524	16	176	14	66	50	15	57	27	43	53
616	27	426	1023	29	593	28	104	90	38	14	53	30	34
67	15	24	64	14	36	14	15	15	14	14	14	14	14
130	14	56	188	14	62	13	17	16	14	14	15	14	14
283	31	165	502	14	226	49	39	42	14	64	21	19	20
564	14	319	1023	14	733	16	89	76	14	363	44	24	23
65	14	21	53	14	56	14	13	13	14	16	14	14	14
155	204	21	142	17	73	51	17	17	22	23	15	31	29
282	24	135	479	14	280	72	18	32	14	114	18	14	19
512	190	164	932	14	750	14	92	63	14	936	38	14	14
28	15	17	54	14	40	40	15	15	21	76	14	14	14
36	115	55	139	24	73	154	33	16	63	51	26	15	14
60	686	156	422	221	48	827	76	14	96	23	90	21	304
252	21	402	543	292	1023	932	192	68	71	105	15	18	806
75	296	14	44	21	12	14	77	15	30	13	15	14	51
14	1009	15	107	38	35	15	14	16	14	349	975	45	893
41	502	206	450	35	14	20	203	148	42	549	752	14	1023
987	1023	353	1023	14	14	14	14	610	14	14	975	14	14
60	64	28	43	15	14	14	57	26	14	27	27	14	29
82	42	88	190	15	21	13	86	38	29	14	17	17	14
248	177	222	599	32	74	14	174	88	43	14	44	30	15
660	276	423	1023	52	276	14	387	190	85	14	99	54	25
72	22	19	103	22	12	11	31	19	52	16	16	18	25
14	199	39	152	46	27	14	110	52	34	289	52	19	81
274	42	199	607	14	128	14	135	72	19	31	37	45	53
631	14	422	1023	32	484	14	288	153	39	14	80	38	28
67	14	26	104	14	17	11	24	18	15	13	16	14	14
126	14	58	222	14	44	13	44	27	17	14	15	14	14
306	55	170	610	14	214	20	94	59	14	14	32	21	14
692	52	350	1023	14	823	14	217	129	27	14	71	44	25
82	15	15	91	14	29	12	19	17	14	13	15	14	14
144	14	44	231	14	62	13	27	22	14	14	15	14	14
355	14	133	582	14	322	14	62	49	14	14	27	14	14
757	24	238	1023	17	925	38	152	105	24	175	60	24	28
76	14	14	82	14	49	14	16	15	14	14	15	14	14
149	22	27	222	14	83	13	19	18	14	47	15	14	14
336	14	72	550	14	320	27	60	42	14	223	24	14	14
643	14	137	1023	14	973	33	138	84	14	661	49	17	17
61	21	13	75	14	73	14	15	15	14	25	14	14	14
15	807	15	136	25	30	324	96	17	84	52	14	27	830
38	506	133	441	32	14	874	197	14	45	164	14	234	872
210	635	30	579	17	1018	917	541	16	697	1023	14	83	873
29	634	15	33	14	14	56	97	28	14	14	24	14	35
14	676	26	134	15	15	16	42	287	15	329	15	14	832
326	1023	120	560	14	14	14	170	179	14	227	552	217	925
1023	1023	287	1023	14	14	14	223	452	14	14	975	14	14
16	267	21	72	14	14	26	62	43	14	75	31	54	35
192	261	30	221	14	13	13	18	160	14	14	14	17	902
289	205	192	697	25	60	14	189	97	40	14	53	27	16
733	274	361	1023	50	350	14	492	224	90	14	115	56	31
64	28	26	100	14	15	11	46	20	24	13	16	14	14
78	288	16	137	90	48	14	124	54	14	217	72	14	81
280	47	178	714	40	171	14	160	80	65	14	40	33	32
763	779	287	1023	33	694	14	417	197	41	14	102	33	21
74	21	19	112	14	19	11	35	17	20	13	16	14	14
134	14	49	243	14	49	13	60	31	19	14	16	14	14
337	25	141	689	21	242	14	126	69	27	14	37	33	22
856	14	254	1023	16	884	14	316	167	18	14	88	26	21
77	32	14	117	14	28	12	26	17	14	13	15	14	15
153	14	35	256	14	67	13	42	26	14	14	15	14	14
386	18	104	671	14	325	21	92	60	14	14	32	14	14
901	201	171	1023	14	838	196	260	145	14	14	76	15	27
73	14	13	123	14	43	13	19	16	14	13	15	14	14
165	14	23	257	14	97	13	29	22	14	14	14	14	14
367	23	77	650	14	376	65	79	52	14	68	29	14	14
862	14	77	1023	14	1007	146	218	122	14	368	69	14	15
63	14	13	112	14	70	14	17	16	14	14	15	14	14
14	14	62	172	14	28	267	98	17	43	14	14	14	173
170	597	74	433	52	384	495	237	17	17	81	67	401	943
282	1023	14	1023	14	1013	975	526	15	660	878	17	16	753];

% 
TLGV.receipe_list=[0 0 0 0 0 0 0 0 1100 0 0 0 0 0];

disp('Searching device...')
TLGV.setting.id=[0;0;0;0];

disp('Awake device...')
status=TL_awakeMode(TLGV.setting.com,TLGV.setting.id,TLGV.setting.modeN,TLGV.setting.timeout); % you can set timeout=0 here to save time.
if(status==0)
   disp('succeed..')
end

TLGV.setting.LEDLayout = [1,2,3,3,12,3,4,5,6,13,7,8,9,3,14,3,10,11,1,14,0,0,0,0];
% TLGV.a=(2:58);
% TLGV.b=1;
% TLGV.a=(1:4:181);
% TLGV.b=1;

TLGV.setting.Channels=max(TLGV.setting.LEDLayout); 
receipe=TLGV.receipe_list(1,:);
TL_lightRecipe(TLGV.setting.com,TLGV.setting.id,receipe,TLGV.setting.timeout,TLGV.setting.LEDLayout);


%         SPD_m1(:,1)=[380:1:780]';
%         SPD_m1(:,2) = Measurement(sscom);
%         XYZ_m1 = spd2xyz(SPD_m1,10)
%         uvY_m1 = xyz2uvY(XYZ_m1);
% 
% 
% spd1=load('04-Nov-2024SPDc1_15.txt');
% spd2=load('04-Nov-2024SPDc2_39.txt');
% spd3=load('04-Nov-2024SPDc3_63.txt');
% spd4=load('04-Nov-2024SPDc4_87.txt');
% spd5=load('04-Nov-2024SPDc5_111.txt');
% spd6=load('04-Nov-2024SPDc6_135.txt');
% spd7=load('04-Nov-2024SPDc7_159.txt');
% spd8=load('04-Nov-2024SPDc8_183.txt');
% spd9=load('04-Nov-2024SPDc9_207.txt');
% spd10=load('04-Nov-2024SPDc10_231.txt');
% spd11=load('04-Nov-2024SPDc11_255.txt');
% spd12=load('04-Nov-2024SPDc12_279.txt');
% spd13=load('04-Nov-2024SPDc13_303.txt');
% spd14=load('04-Nov-2024SPDc14_327.txt');
% 
%     total=spd1(:,2)+spd2(:,2)+spd3(:,2)+spd4(:,2)+spd5(:,2)+spd6(:,2)+...
%         +spd7(:,2)+spd8(:,2)+spd9(:,2)+spd10(:,2)+spd11(:,2)+spd12(:,2)+spd13(:,2)+spd14(:,2);
% spdtotal=[spd1(:,1),total];
% 
% XYZtest = spd2xyz(spdtotal,10)
% uvtest= xyz2uvY(XYZtest);
% deuv=deltaE(uvtest,uvY_m1,12)
%% calibration
TLGV.calibration.date=date;

%% CCT to xyz
switch TLGV.obs
    case 2
        TLGV.ColourTemp=ColourTemp193102;
    case 1931
        TLGV.ColourTemp=ColourTemp193102;
    case 10
        TLGV.ColourTemp=ColourTemp196410;
    case 1964
        TLGV.ColourTemp=ColourTemp196410;
    case 2006
        TLGV.ColourTemp=ColourTemp200610;
    case 200602
        TLGV.ColourTemp=ColourTemp200602;
    case 200610
        TLGV.ColourTemp=ColourTemp200610;    
end